---
title: "Ancestral sequence analysis"
output:
  html_document:
    df_print: paged
editor_options: 
  markdown: 
    wrap: sentence
---

### Intrioduction

This guide provides an introduction to working with ancestral sequence files generated by TnT.
The file has a row for each reconstructed sequence and 6 columns:

-   **Sample:** Indicates the number of posterior sample obtained by MCMC.
    It corresponds to the sample number in the other BEAST log files.

-   **Transmission Type:** Can be observed or hidden.
    For observed events, it specifies whether the sequence is transmitted (on the recipient side, *OBSERVED_TRANSMITTED*) or untransmitted (donor side, *OBSERVED_UNTRANSMITTED*).
    For hidden events, t indicates if the event was informed by genetic data on the gene tree (HIDDEN_GENE) or reconstructed by stochastic mapping alone (HIDDEN).
    All hidden sequences are considered transmitted by default, as untransmitted sequences cannot be recovered for hidden events.

-   **Transmission Time:** iRepresents the unique time of a transmission event at which the sequence was transmitted or untransmitted.
    Together with the **Sample** column, it allows retrieval of all sequences involved in a particular transmission event.

-   **Donordescendants:** Lists the sample labels of hosts that descend from the donor at this transmission event.
    This field is empty for hidden transmission events since tracing the donor is not possible.

-   **Recipient descendants:** Lists the sample labels of the hosts that descend from the recipient at this transmission event.

-   **Sequence:** Contains the reconstructed ancestral sequence.

Note: the *Donor descendants* and *Recipient descendants* fields correspond to a transmission event and are not unique per sequence.

Below are some examples demonstrating how to extract sequences and their properties from this file.
In the last section, we provide instructions for cases where the sequence file is too large to load at once.

First, let's load the sequences file (you may need to modify the `seqs_file_path` value).

```{r}
seqs_file_path <- "~/Documents/Source/TnT/examples/ancestral_sequence_simulation/Sequences_example.txt"
sequence_file <- read.csv(seqs_file_path, header=TRUE, sep="\t")
head(sequence_file)
```

Next, we can determine the number of unique posterior samples in the file:

```{r}
get_sample_ids <- unique(sequence_file$Sample)
print(length(get_sample_ids))
#transmission_types <- unique(sequence_file$Transmission.Type)
```

Suppose we want to examine the first posterior sample.
We can retrieve all the unique transmission times associated with it, which also reveals the number of recorded transmission events are recorded:

```{r}
sample <- 1
tr_event_times_sample1 <- unique(sequence_file[which(sequence_file$Sample==get_sample_ids[sample]),
                                   "Transmission.Time"])
n_events <-  length(tr_event_times_sample1)
cat("There are ", n_events, " transmission events. Their times are: ", c(tr_event_times_sample1))
```

Let's focus on event 7.
We can find its type and time:

```{r}
tr_event <- 7
tr_sample1_event7_ids <- which(sequence_file$Sample==get_sample_ids[sample] &
              sequence_file$Transmission.Time==tr_event_times_sample1[tr_event])
cat("Type of the transmission event 7 and sequences: ",
             sequence_file$Transmission.Type[tr_sample1_event7_ids], "\n", sep=" ")
cat("Time of the transmission event 7: ",
             tr_event_times_sample1[tr_event])
```

Additionally, we can separate transmitted and untransmitted sequences and identify the host samples that are descendants of the donor or recipient at this transmission event:

```{r}
sequences_sample_1_event_7 <- sequence_file$Sequence[tr_sample1_event7_ids]
untransmitted_sequences_ids <- grep('UNTRANSMITTED', sequence_file$Transmission.Type[tr_sample1_event7_ids])
transmitted_sequences_ids <- grep('TRANSMITTED', sequence_file$Transmission.Type[tr_sample1_event7_ids])
untransmitted_sequences_event7 <- sequences_sample_1_event_7[untransmitted_sequences_ids]
transmitted_sequences_event7 <- sequences_sample_1_event_7[transmitted_sequences_ids]

recipient_descendants_event7 <- unique(sequence_file$Recipient.descendants[tr_sample1_event7_ids])
donor_descendants_event7 <- unique(sequence_file$Donor.descendants[tr_sample1_event7_ids])
```

### Working with Large Sequence Files

In cases where the entire file cannot be loaded into memory, follow these steps to collect unique posterior sample numbers:

```{r}
con  <- file(seqs_file_path, open = "r")
s <- ""
samples <- c()
start_line <- c()
end_line <- c()
line <- 0
while (length(myLine <- scan(con,what=character(),nlines=1,sep='\t',quiet=TRUE)) > 0 ){
  line = line+1
  if (line==1){
    header <- myLine
    next
  }
  s <- myLine[1]
  if (line==2){
    start_line <- c(start_line, line)
    samples <- c(samples, s)
  } else if(samples[length(samples)]!=s){
    end_line <- c(end_line,line-1)
    start_line <- c(start_line, line)
    samples <- c(samples, s)
  }
} 
end_line<- c(end_line, line)
close(con)
```

To display all posterior sample numbers in the file:

```{r}
print(samples)
```

Suppose we choose the second sample with number "665000000" and wish to read only the sequences and metadata associated with it:.
We collect these into a separate dataframe:

```{r}
ids_665000000 <- which(samples=="665000000")
start <- start_line[ids_665000000]
end <- end_line[ids_665000000]

data_665000000 <- read.csv(seqs_file_path, skip=start,nrows=end, sep="\t", header = F)
colnames(data_665000000) <- header
head(data_665000000)
```

You can use this dataframe as shown in the previous sections when loading the entire sequence file to obtain information on transmission events and (un)transmitted sequences.
